{"ast":null,"code":"'use strict';\n\nvar TraversalTracker = require('./traversalTracker');\n\nvar DocPreprocessor = require('./docPreprocessor');\n\nvar DocMeasure = require('./docMeasure');\n\nvar DocumentContext = require('./documentContext');\n\nvar PageElementWriter = require('./pageElementWriter');\n\nvar ColumnCalculator = require('./columnCalculator');\n\nvar TableProcessor = require('./tableProcessor');\n\nvar Line = require('./line');\n\nvar isString = require('./helpers').isString;\n\nvar isArray = require('./helpers').isArray;\n\nvar isUndefined = require('./helpers').isUndefined;\n\nvar isNull = require('./helpers').isNull;\n\nvar pack = require('./helpers').pack;\n\nvar offsetVector = require('./helpers').offsetVector;\n\nvar fontStringify = require('./helpers').fontStringify;\n\nvar getNodeId = require('./helpers').getNodeId;\n\nvar isFunction = require('./helpers').isFunction;\n\nvar TextTools = require('./textTools');\n\nvar StyleContextStack = require('./styleContextStack');\n\nvar isNumber = require('./helpers').isNumber;\n\nfunction addAll(target, otherArray) {\n  otherArray.forEach(function (item) {\n    target.push(item);\n  });\n}\n/**\r\n * Creates an instance of LayoutBuilder - layout engine which turns document-definition-object\r\n * into a set of pages, lines, inlines and vectors ready to be rendered into a PDF\r\n *\r\n * @param {Object} pageSize - an object defining page width and height\r\n * @param {Object} pageMargins - an object defining top, left, right and bottom margins\r\n */\n\n\nfunction LayoutBuilder(pageSize, pageMargins, imageMeasure, svgMeasure) {\n  this.pageSize = pageSize;\n  this.pageMargins = pageMargins;\n  this.tracker = new TraversalTracker();\n  this.imageMeasure = imageMeasure;\n  this.svgMeasure = svgMeasure;\n  this.tableLayouts = {};\n}\n\nLayoutBuilder.prototype.registerTableLayouts = function (tableLayouts) {\n  this.tableLayouts = pack(this.tableLayouts, tableLayouts);\n};\n/**\r\n * Executes layout engine on document-definition-object and creates an array of pages\r\n * containing positioned Blocks, Lines and inlines\r\n *\r\n * @param {Object} docStructure document-definition-object\r\n * @param {Object} fontProvider font provider\r\n * @param {Object} styleDictionary dictionary with style definitions\r\n * @param {Object} defaultStyle default style definition\r\n * @return {Array} an array of pages\r\n */\n\n\nLayoutBuilder.prototype.layoutDocument = function (docStructure, fontProvider, styleDictionary, defaultStyle, background, header, footer, images, watermark, pageBreakBeforeFct) {\n  function addPageBreaksIfNecessary(linearNodeList, pages) {\n    if (!isFunction(pageBreakBeforeFct)) {\n      return false;\n    }\n\n    linearNodeList = linearNodeList.filter(function (node) {\n      return node.positions.length > 0;\n    });\n    linearNodeList.forEach(function (node) {\n      var nodeInfo = {};\n      ['id', 'text', 'ul', 'ol', 'table', 'image', 'qr', 'canvas', 'svg', 'columns', 'headlineLevel', 'style', 'pageBreak', 'pageOrientation', 'width', 'height'].forEach(function (key) {\n        if (node[key] !== undefined) {\n          nodeInfo[key] = node[key];\n        }\n      });\n      nodeInfo.startPosition = node.positions[0];\n      nodeInfo.pageNumbers = Array.from(new Set(node.positions.map(function (node) {\n        return node.pageNumber;\n      })));\n      nodeInfo.pages = pages.length;\n      nodeInfo.stack = isArray(node.stack);\n      node.nodeInfo = nodeInfo;\n    });\n\n    for (var index = 0; index < linearNodeList.length; index++) {\n      var node = linearNodeList[index];\n\n      if (node.pageBreak !== 'before' && !node.pageBreakCalculated) {\n        node.pageBreakCalculated = true;\n        var pageNumber = node.nodeInfo.pageNumbers[0];\n        var followingNodesOnPage = [];\n        var nodesOnNextPage = [];\n        var previousNodesOnPage = [];\n\n        if (pageBreakBeforeFct.length > 1) {\n          for (var ii = index + 1, l = linearNodeList.length; ii < l; ii++) {\n            if (linearNodeList[ii].nodeInfo.pageNumbers.indexOf(pageNumber) > -1) {\n              followingNodesOnPage.push(linearNodeList[ii].nodeInfo);\n            }\n\n            if (pageBreakBeforeFct.length > 2 && linearNodeList[ii].nodeInfo.pageNumbers.indexOf(pageNumber + 1) > -1) {\n              nodesOnNextPage.push(linearNodeList[ii].nodeInfo);\n            }\n          }\n        }\n\n        if (pageBreakBeforeFct.length > 3) {\n          for (var ii = 0; ii < index; ii++) {\n            if (linearNodeList[ii].nodeInfo.pageNumbers.indexOf(pageNumber) > -1) {\n              previousNodesOnPage.push(linearNodeList[ii].nodeInfo);\n            }\n          }\n        }\n\n        if (pageBreakBeforeFct(node.nodeInfo, followingNodesOnPage, nodesOnNextPage, previousNodesOnPage)) {\n          node.pageBreak = 'before';\n          return true;\n        }\n      }\n    }\n\n    return false;\n  }\n\n  this.docPreprocessor = new DocPreprocessor();\n  this.docMeasure = new DocMeasure(fontProvider, styleDictionary, defaultStyle, this.imageMeasure, this.svgMeasure, this.tableLayouts, images);\n\n  function resetXYs(result) {\n    result.linearNodeList.forEach(function (node) {\n      node.resetXY();\n    });\n  }\n\n  var result = this.tryLayoutDocument(docStructure, fontProvider, styleDictionary, defaultStyle, background, header, footer, images, watermark);\n\n  while (addPageBreaksIfNecessary(result.linearNodeList, result.pages)) {\n    resetXYs(result);\n    result = this.tryLayoutDocument(docStructure, fontProvider, styleDictionary, defaultStyle, background, header, footer, images, watermark);\n  }\n\n  return result.pages;\n};\n\nLayoutBuilder.prototype.tryLayoutDocument = function (docStructure, fontProvider, styleDictionary, defaultStyle, background, header, footer, images, watermark, pageBreakBeforeFct) {\n  this.linearNodeList = [];\n  docStructure = this.docPreprocessor.preprocessDocument(docStructure);\n  docStructure = this.docMeasure.measureDocument(docStructure);\n  this.writer = new PageElementWriter(new DocumentContext(this.pageSize, this.pageMargins), this.tracker);\n\n  var _this = this;\n\n  this.writer.context().tracker.startTracking('pageAdded', function () {\n    _this.addBackground(background);\n  });\n  this.addBackground(background);\n  this.processNode(docStructure);\n  this.addHeadersAndFooters(header, footer);\n\n  if (watermark != null) {\n    this.addWatermark(watermark, fontProvider, defaultStyle);\n  }\n\n  return {\n    pages: this.writer.context().pages,\n    linearNodeList: this.linearNodeList\n  };\n};\n\nLayoutBuilder.prototype.addBackground = function (background) {\n  var backgroundGetter = isFunction(background) ? background : function () {\n    return background;\n  };\n  var context = this.writer.context();\n  var pageSize = context.getCurrentPage().pageSize;\n  var pageBackground = backgroundGetter(context.page + 1, pageSize);\n\n  if (pageBackground) {\n    this.writer.beginUnbreakableBlock(pageSize.width, pageSize.height);\n    pageBackground = this.docPreprocessor.preprocessDocument(pageBackground);\n    this.processNode(this.docMeasure.measureDocument(pageBackground));\n    this.writer.commitUnbreakableBlock(0, 0);\n    context.backgroundLength[context.page] += pageBackground.positions.length;\n  }\n};\n\nLayoutBuilder.prototype.addStaticRepeatable = function (headerOrFooter, sizeFunction) {\n  this.addDynamicRepeatable(function () {\n    return JSON.parse(JSON.stringify(headerOrFooter)); // copy to new object\n  }, sizeFunction);\n};\n\nLayoutBuilder.prototype.addDynamicRepeatable = function (nodeGetter, sizeFunction) {\n  var pages = this.writer.context().pages;\n\n  for (var pageIndex = 0, l = pages.length; pageIndex < l; pageIndex++) {\n    this.writer.context().page = pageIndex;\n    var node = nodeGetter(pageIndex + 1, l, this.writer.context().pages[pageIndex].pageSize);\n\n    if (node) {\n      var sizes = sizeFunction(this.writer.context().getCurrentPage().pageSize, this.pageMargins);\n      this.writer.beginUnbreakableBlock(sizes.width, sizes.height);\n      node = this.docPreprocessor.preprocessDocument(node);\n      this.processNode(this.docMeasure.measureDocument(node));\n      this.writer.commitUnbreakableBlock(sizes.x, sizes.y);\n    }\n  }\n};\n\nLayoutBuilder.prototype.addHeadersAndFooters = function (header, footer) {\n  var headerSizeFct = function (pageSize, pageMargins) {\n    return {\n      x: 0,\n      y: 0,\n      width: pageSize.width,\n      height: pageMargins.top\n    };\n  };\n\n  var footerSizeFct = function (pageSize, pageMargins) {\n    return {\n      x: 0,\n      y: pageSize.height - pageMargins.bottom,\n      width: pageSize.width,\n      height: pageMargins.bottom\n    };\n  };\n\n  if (isFunction(header)) {\n    this.addDynamicRepeatable(header, headerSizeFct);\n  } else if (header) {\n    this.addStaticRepeatable(header, headerSizeFct);\n  }\n\n  if (isFunction(footer)) {\n    this.addDynamicRepeatable(footer, footerSizeFct);\n  } else if (footer) {\n    this.addStaticRepeatable(footer, footerSizeFct);\n  }\n};\n\nLayoutBuilder.prototype.addWatermark = function (watermark, fontProvider, defaultStyle) {\n  if (isString(watermark)) {\n    watermark = {\n      'text': watermark\n    };\n  }\n\n  if (!watermark.text) {\n    // empty watermark text\n    return;\n  }\n\n  watermark.font = watermark.font || defaultStyle.font || 'Roboto';\n  watermark.fontSize = watermark.fontSize || 'auto';\n  watermark.color = watermark.color || 'black';\n  watermark.opacity = isNumber(watermark.opacity) ? watermark.opacity : 0.6;\n  watermark.bold = watermark.bold || false;\n  watermark.italics = watermark.italics || false;\n  watermark.angle = !isUndefined(watermark.angle) && !isNull(watermark.angle) ? watermark.angle : null;\n\n  if (watermark.angle === null) {\n    watermark.angle = Math.atan2(this.pageSize.height, this.pageSize.width) * -180 / Math.PI;\n  }\n\n  if (watermark.fontSize === 'auto') {\n    watermark.fontSize = getWatermarkFontSize(this.pageSize, watermark, fontProvider);\n  }\n\n  var watermarkObject = {\n    text: watermark.text,\n    font: fontProvider.provideFont(watermark.font, watermark.bold, watermark.italics),\n    fontSize: watermark.fontSize,\n    color: watermark.color,\n    opacity: watermark.opacity,\n    angle: watermark.angle\n  };\n  watermarkObject._size = getWatermarkSize(watermark, fontProvider);\n  var pages = this.writer.context().pages;\n\n  for (var i = 0, l = pages.length; i < l; i++) {\n    pages[i].watermark = watermarkObject;\n  }\n\n  function getWatermarkSize(watermark, fontProvider) {\n    var textTools = new TextTools(fontProvider);\n    var styleContextStack = new StyleContextStack(null, {\n      font: watermark.font,\n      bold: watermark.bold,\n      italics: watermark.italics\n    });\n    styleContextStack.push({\n      fontSize: watermark.fontSize\n    });\n    var size = textTools.sizeOfString(watermark.text, styleContextStack);\n    var rotatedSize = textTools.sizeOfRotatedText(watermark.text, watermark.angle, styleContextStack);\n    return {\n      size: size,\n      rotatedSize: rotatedSize\n    };\n  }\n\n  function getWatermarkFontSize(pageSize, watermark, fontProvider) {\n    var textTools = new TextTools(fontProvider);\n    var styleContextStack = new StyleContextStack(null, {\n      font: watermark.font,\n      bold: watermark.bold,\n      italics: watermark.italics\n    });\n    var rotatedSize;\n    /**\r\n     * Binary search the best font size.\r\n     * Initial bounds [0, 1000]\r\n     * Break when range < 1\r\n     */\n\n    var a = 0;\n    var b = 1000;\n    var c = (a + b) / 2;\n\n    while (Math.abs(a - b) > 1) {\n      styleContextStack.push({\n        fontSize: c\n      });\n      rotatedSize = textTools.sizeOfRotatedText(watermark.text, watermark.angle, styleContextStack);\n\n      if (rotatedSize.width > pageSize.width) {\n        b = c;\n        c = (a + b) / 2;\n      } else if (rotatedSize.width < pageSize.width) {\n        if (rotatedSize.height > pageSize.height) {\n          b = c;\n          c = (a + b) / 2;\n        } else {\n          a = c;\n          c = (a + b) / 2;\n        }\n      }\n\n      styleContextStack.pop();\n    }\n    /*\r\n     End binary search\r\n     */\n\n\n    return c;\n  }\n};\n\nfunction decorateNode(node) {\n  var x = node.x,\n      y = node.y;\n  node.positions = [];\n\n  if (isArray(node.canvas)) {\n    node.canvas.forEach(function (vector) {\n      var x = vector.x,\n          y = vector.y,\n          x1 = vector.x1,\n          y1 = vector.y1,\n          x2 = vector.x2,\n          y2 = vector.y2;\n\n      vector.resetXY = function () {\n        vector.x = x;\n        vector.y = y;\n        vector.x1 = x1;\n        vector.y1 = y1;\n        vector.x2 = x2;\n        vector.y2 = y2;\n      };\n    });\n  }\n\n  node.resetXY = function () {\n    node.x = x;\n    node.y = y;\n\n    if (isArray(node.canvas)) {\n      node.canvas.forEach(function (vector) {\n        vector.resetXY();\n      });\n    }\n  };\n}\n\nLayoutBuilder.prototype.processNode = function (node) {\n  var self = this;\n  this.linearNodeList.push(node);\n  decorateNode(node);\n  applyMargins(function () {\n    var unbreakable = node.unbreakable;\n\n    if (unbreakable) {\n      self.writer.beginUnbreakableBlock();\n    }\n\n    var absPosition = node.absolutePosition;\n\n    if (absPosition) {\n      self.writer.context().beginDetachedBlock();\n      self.writer.context().moveTo(absPosition.x || 0, absPosition.y || 0);\n    }\n\n    var relPosition = node.relativePosition;\n\n    if (relPosition) {\n      self.writer.context().beginDetachedBlock();\n      self.writer.context().moveToRelative(relPosition.x || 0, relPosition.y || 0);\n    }\n\n    if (node.stack) {\n      self.processVerticalContainer(node);\n    } else if (node.columns) {\n      self.processColumns(node);\n    } else if (node.ul) {\n      self.processList(false, node);\n    } else if (node.ol) {\n      self.processList(true, node);\n    } else if (node.table) {\n      self.processTable(node);\n    } else if (node.text !== undefined) {\n      self.processLeaf(node);\n    } else if (node.toc) {\n      self.processToc(node);\n    } else if (node.image) {\n      self.processImage(node);\n    } else if (node.svg) {\n      self.processSVG(node);\n    } else if (node.canvas) {\n      self.processCanvas(node);\n    } else if (node.qr) {\n      self.processQr(node);\n    } else if (!node._span) {\n      throw 'Unrecognized document structure: ' + JSON.stringify(node, fontStringify);\n    }\n\n    if (absPosition || relPosition) {\n      self.writer.context().endDetachedBlock();\n    }\n\n    if (unbreakable) {\n      self.writer.commitUnbreakableBlock();\n    }\n  });\n\n  function applyMargins(callback) {\n    var margin = node._margin;\n\n    if (node.pageBreak === 'before') {\n      self.writer.moveToNextPage(node.pageOrientation);\n    } else if (node.pageBreak === 'beforeOdd') {\n      self.writer.moveToNextPage(node.pageOrientation);\n\n      if ((self.writer.context().page + 1) % 2 === 1) {\n        self.writer.moveToNextPage(node.pageOrientation);\n      }\n    } else if (node.pageBreak === 'beforeEven') {\n      self.writer.moveToNextPage(node.pageOrientation);\n\n      if ((self.writer.context().page + 1) % 2 === 0) {\n        self.writer.moveToNextPage(node.pageOrientation);\n      }\n    }\n\n    if (margin) {\n      self.writer.context().moveDown(margin[1]);\n      self.writer.context().addMargin(margin[0], margin[2]);\n    }\n\n    callback();\n\n    if (margin) {\n      self.writer.context().addMargin(-margin[0], -margin[2]);\n      self.writer.context().moveDown(margin[3]);\n    }\n\n    if (node.pageBreak === 'after') {\n      self.writer.moveToNextPage(node.pageOrientation);\n    } else if (node.pageBreak === 'afterOdd') {\n      self.writer.moveToNextPage(node.pageOrientation);\n\n      if ((self.writer.context().page + 1) % 2 === 1) {\n        self.writer.moveToNextPage(node.pageOrientation);\n      }\n    } else if (node.pageBreak === 'afterEven') {\n      self.writer.moveToNextPage(node.pageOrientation);\n\n      if ((self.writer.context().page + 1) % 2 === 0) {\n        self.writer.moveToNextPage(node.pageOrientation);\n      }\n    }\n  }\n}; // vertical container\n\n\nLayoutBuilder.prototype.processVerticalContainer = function (node) {\n  var self = this;\n  node.stack.forEach(function (item) {\n    self.processNode(item);\n    addAll(node.positions, item.positions); //TODO: paragraph gap\n  });\n}; // columns\n\n\nLayoutBuilder.prototype.processColumns = function (columnNode) {\n  var columns = columnNode.columns;\n  var availableWidth = this.writer.context().availableWidth;\n  var gaps = gapArray(columnNode._gap);\n\n  if (gaps) {\n    availableWidth -= (gaps.length - 1) * columnNode._gap;\n  }\n\n  ColumnCalculator.buildColumnWidths(columns, availableWidth);\n  var result = this.processRow(columns, columns, gaps);\n  addAll(columnNode.positions, result.positions);\n\n  function gapArray(gap) {\n    if (!gap) {\n      return null;\n    }\n\n    var gaps = [];\n    gaps.push(0);\n\n    for (var i = columns.length - 1; i > 0; i--) {\n      gaps.push(gap);\n    }\n\n    return gaps;\n  }\n};\n\nLayoutBuilder.prototype.processRow = function (columns, widths, gaps, tableBody, tableRow, height) {\n  var self = this;\n  var pageBreaks = [],\n      positions = [];\n  this.tracker.auto('pageChanged', storePageBreakData, function () {\n    widths = widths || columns;\n    self.writer.context().beginColumnGroup();\n\n    for (var i = 0, l = columns.length; i < l; i++) {\n      var column = columns[i];\n      var width = widths[i]._calcWidth;\n      var leftOffset = colLeftOffset(i);\n\n      if (column.colSpan && column.colSpan > 1) {\n        for (var j = 1; j < column.colSpan; j++) {\n          width += widths[++i]._calcWidth + gaps[i];\n        }\n      }\n\n      self.writer.context().beginColumn(width, leftOffset, getEndingCell(column, i));\n\n      if (!column._span) {\n        self.processNode(column);\n        addAll(positions, column.positions);\n      } else if (column._columnEndingContext) {\n        // row-span ending\n        self.writer.context().markEnding(column);\n      }\n    }\n\n    self.writer.context().completeColumnGroup(height);\n  });\n  return {\n    pageBreaks: pageBreaks,\n    positions: positions\n  };\n\n  function storePageBreakData(data) {\n    var pageDesc;\n\n    for (var i = 0, l = pageBreaks.length; i < l; i++) {\n      var desc = pageBreaks[i];\n\n      if (desc.prevPage === data.prevPage) {\n        pageDesc = desc;\n        break;\n      }\n    }\n\n    if (!pageDesc) {\n      pageDesc = data;\n      pageBreaks.push(pageDesc);\n    }\n\n    pageDesc.prevY = Math.max(pageDesc.prevY, data.prevY);\n    pageDesc.y = Math.min(pageDesc.y, data.y);\n  }\n\n  function colLeftOffset(i) {\n    if (gaps && gaps.length > i) {\n      return gaps[i];\n    }\n\n    return 0;\n  }\n\n  function getEndingCell(column, columnIndex) {\n    if (column.rowSpan && column.rowSpan > 1) {\n      var endingRow = tableRow + column.rowSpan - 1;\n\n      if (endingRow >= tableBody.length) {\n        throw 'Row span for column ' + columnIndex + ' (with indexes starting from 0) exceeded row count';\n      }\n\n      return tableBody[endingRow][columnIndex];\n    }\n\n    return null;\n  }\n}; // lists\n\n\nLayoutBuilder.prototype.processList = function (orderedList, node) {\n  var self = this,\n      items = orderedList ? node.ol : node.ul,\n      gapSize = node._gapSize;\n  this.writer.context().addMargin(gapSize.width);\n  var nextMarker;\n  this.tracker.auto('lineAdded', addMarkerToFirstLeaf, function () {\n    items.forEach(function (item) {\n      nextMarker = item.listMarker;\n      self.processNode(item);\n      addAll(node.positions, item.positions);\n    });\n  });\n  this.writer.context().addMargin(-gapSize.width);\n\n  function addMarkerToFirstLeaf(line) {\n    // I'm not very happy with the way list processing is implemented\n    // (both code and algorithm should be rethinked)\n    if (nextMarker) {\n      var marker = nextMarker;\n      nextMarker = null;\n\n      if (marker.canvas) {\n        var vector = marker.canvas[0];\n        offsetVector(vector, -marker._minWidth, 0);\n        self.writer.addVector(vector);\n      } else if (marker._inlines) {\n        var markerLine = new Line(self.pageSize.width);\n        markerLine.addInline(marker._inlines[0]);\n        markerLine.x = -marker._minWidth;\n        markerLine.y = line.getAscenderHeight() - markerLine.getAscenderHeight();\n        self.writer.addLine(markerLine, true);\n      }\n    }\n  }\n}; // tables\n\n\nLayoutBuilder.prototype.processTable = function (tableNode) {\n  var processor = new TableProcessor(tableNode);\n  processor.beginTable(this.writer);\n  var rowHeights = tableNode.table.heights;\n\n  for (var i = 0, l = tableNode.table.body.length; i < l; i++) {\n    processor.beginRow(i, this.writer);\n    var height;\n\n    if (isFunction(rowHeights)) {\n      height = rowHeights(i);\n    } else if (isArray(rowHeights)) {\n      height = rowHeights[i];\n    } else {\n      height = rowHeights;\n    }\n\n    if (height === 'auto') {\n      height = undefined;\n    }\n\n    var result = this.processRow(tableNode.table.body[i], tableNode.table.widths, tableNode._offsets.offsets, tableNode.table.body, i, height);\n    addAll(tableNode.positions, result.positions);\n    processor.endRow(i, this.writer, result.pageBreaks);\n  }\n\n  processor.endTable(this.writer);\n}; // leafs (texts)\n\n\nLayoutBuilder.prototype.processLeaf = function (node) {\n  var line = this.buildNextLine(node);\n\n  if (line && (node.tocItem || node.id)) {\n    line._node = node;\n  }\n\n  var currentHeight = line ? line.getHeight() : 0;\n  var maxHeight = node.maxHeight || -1;\n\n  if (line) {\n    var nodeId = getNodeId(node);\n\n    if (nodeId) {\n      line.id = nodeId;\n    }\n  }\n\n  if (node._tocItemRef) {\n    line._pageNodeRef = node._tocItemRef;\n  }\n\n  if (node._pageRef) {\n    line._pageNodeRef = node._pageRef._nodeRef;\n  }\n\n  if (line && line.inlines && isArray(line.inlines)) {\n    for (var i = 0, l = line.inlines.length; i < l; i++) {\n      if (line.inlines[i]._tocItemRef) {\n        line.inlines[i]._pageNodeRef = line.inlines[i]._tocItemRef;\n      }\n\n      if (line.inlines[i]._pageRef) {\n        line.inlines[i]._pageNodeRef = line.inlines[i]._pageRef._nodeRef;\n      }\n    }\n  }\n\n  while (line && (maxHeight === -1 || currentHeight < maxHeight)) {\n    var positions = this.writer.addLine(line);\n    node.positions.push(positions);\n    line = this.buildNextLine(node);\n\n    if (line) {\n      currentHeight += line.getHeight();\n    }\n  }\n};\n\nLayoutBuilder.prototype.processToc = function (node) {\n  if (node.toc.title) {\n    this.processNode(node.toc.title);\n  }\n\n  if (node.toc._table) {\n    this.processNode(node.toc._table);\n  }\n};\n\nLayoutBuilder.prototype.buildNextLine = function (textNode) {\n  function cloneInline(inline) {\n    var newInline = inline.constructor();\n\n    for (var key in inline) {\n      newInline[key] = inline[key];\n    }\n\n    return newInline;\n  }\n\n  if (!textNode._inlines || textNode._inlines.length === 0) {\n    return null;\n  }\n\n  var line = new Line(this.writer.context().availableWidth);\n  var textTools = new TextTools(null);\n  var isForceContinue = false;\n\n  while (textNode._inlines && textNode._inlines.length > 0 && (line.hasEnoughSpaceForInline(textNode._inlines[0], textNode._inlines.slice(1)) || isForceContinue)) {\n    var isHardWrap = false;\n\n    var inline = textNode._inlines.shift();\n\n    isForceContinue = false;\n\n    if (!inline.noWrap && inline.text.length > 1 && inline.width > line.getAvailableWidth()) {\n      var widthPerChar = inline.width / inline.text.length;\n      var maxChars = Math.floor(line.getAvailableWidth() / widthPerChar);\n\n      if (maxChars < 1) {\n        maxChars = 1;\n      }\n\n      if (maxChars < inline.text.length) {\n        var newInline = cloneInline(inline);\n        newInline.text = inline.text.substr(maxChars);\n        inline.text = inline.text.substr(0, maxChars);\n        newInline.width = textTools.widthOfString(newInline.text, newInline.font, newInline.fontSize, newInline.characterSpacing, newInline.fontFeatures);\n        inline.width = textTools.widthOfString(inline.text, inline.font, inline.fontSize, inline.characterSpacing, inline.fontFeatures);\n\n        textNode._inlines.unshift(newInline);\n\n        isHardWrap = true;\n      }\n    }\n\n    line.addInline(inline);\n    isForceContinue = inline.noNewLine && !isHardWrap;\n  }\n\n  line.lastLineInParagraph = textNode._inlines.length === 0;\n  return line;\n}; // images\n\n\nLayoutBuilder.prototype.processImage = function (node) {\n  var position = this.writer.addImage(node);\n  node.positions.push(position);\n};\n\nLayoutBuilder.prototype.processSVG = function (node) {\n  var position = this.writer.addSVG(node);\n  node.positions.push(position);\n};\n\nLayoutBuilder.prototype.processCanvas = function (node) {\n  var height = node._minHeight;\n\n  if (node.absolutePosition === undefined && this.writer.context().availableHeight < height) {\n    // TODO: support for canvas larger than a page\n    // TODO: support for other overflow methods\n    this.writer.moveToNextPage();\n  }\n\n  this.writer.alignCanvas(node);\n  node.canvas.forEach(function (vector) {\n    var position = this.writer.addVector(vector);\n    node.positions.push(position);\n  }, this);\n  this.writer.context().moveDown(height);\n};\n\nLayoutBuilder.prototype.processQr = function (node) {\n  var position = this.writer.addQr(node);\n  node.positions.push(position);\n};\n\nmodule.exports = LayoutBuilder;","map":{"version":3,"sources":["/home/julianallende/Desktop/proyecto_sapo/client/node_modules/pdfmake/src/layoutBuilder.js"],"names":["TraversalTracker","require","DocPreprocessor","DocMeasure","DocumentContext","PageElementWriter","ColumnCalculator","TableProcessor","Line","isString","isArray","isUndefined","isNull","pack","offsetVector","fontStringify","getNodeId","isFunction","TextTools","StyleContextStack","isNumber","addAll","target","otherArray","forEach","item","push","LayoutBuilder","pageSize","pageMargins","imageMeasure","svgMeasure","tracker","tableLayouts","prototype","registerTableLayouts","layoutDocument","docStructure","fontProvider","styleDictionary","defaultStyle","background","header","footer","images","watermark","pageBreakBeforeFct","addPageBreaksIfNecessary","linearNodeList","pages","filter","node","positions","length","nodeInfo","key","undefined","startPosition","pageNumbers","Array","from","Set","map","pageNumber","stack","index","pageBreak","pageBreakCalculated","followingNodesOnPage","nodesOnNextPage","previousNodesOnPage","ii","l","indexOf","docPreprocessor","docMeasure","resetXYs","result","resetXY","tryLayoutDocument","preprocessDocument","measureDocument","writer","_this","context","startTracking","addBackground","processNode","addHeadersAndFooters","addWatermark","backgroundGetter","getCurrentPage","pageBackground","page","beginUnbreakableBlock","width","height","commitUnbreakableBlock","backgroundLength","addStaticRepeatable","headerOrFooter","sizeFunction","addDynamicRepeatable","JSON","parse","stringify","nodeGetter","pageIndex","sizes","x","y","headerSizeFct","top","footerSizeFct","bottom","text","font","fontSize","color","opacity","bold","italics","angle","Math","atan2","PI","getWatermarkFontSize","watermarkObject","provideFont","_size","getWatermarkSize","i","textTools","styleContextStack","size","sizeOfString","rotatedSize","sizeOfRotatedText","a","b","c","abs","pop","decorateNode","canvas","vector","x1","y1","x2","y2","self","applyMargins","unbreakable","absPosition","absolutePosition","beginDetachedBlock","moveTo","relPosition","relativePosition","moveToRelative","processVerticalContainer","columns","processColumns","ul","processList","ol","table","processTable","processLeaf","toc","processToc","image","processImage","svg","processSVG","processCanvas","qr","processQr","_span","endDetachedBlock","callback","margin","_margin","moveToNextPage","pageOrientation","moveDown","addMargin","columnNode","availableWidth","gaps","gapArray","_gap","buildColumnWidths","processRow","gap","widths","tableBody","tableRow","pageBreaks","auto","storePageBreakData","beginColumnGroup","column","_calcWidth","leftOffset","colLeftOffset","colSpan","j","beginColumn","getEndingCell","_columnEndingContext","markEnding","completeColumnGroup","data","pageDesc","desc","prevPage","prevY","max","min","columnIndex","rowSpan","endingRow","orderedList","items","gapSize","_gapSize","nextMarker","addMarkerToFirstLeaf","listMarker","line","marker","_minWidth","addVector","_inlines","markerLine","addInline","getAscenderHeight","addLine","tableNode","processor","beginTable","rowHeights","heights","body","beginRow","_offsets","offsets","endRow","endTable","buildNextLine","tocItem","id","_node","currentHeight","getHeight","maxHeight","nodeId","_tocItemRef","_pageNodeRef","_pageRef","_nodeRef","inlines","title","_table","textNode","cloneInline","inline","newInline","constructor","isForceContinue","hasEnoughSpaceForInline","slice","isHardWrap","shift","noWrap","getAvailableWidth","widthPerChar","maxChars","floor","substr","widthOfString","characterSpacing","fontFeatures","unshift","noNewLine","lastLineInParagraph","position","addImage","addSVG","_minHeight","availableHeight","alignCanvas","addQr","module","exports"],"mappings":"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","sourcesContent":["'use strict';\r\n\r\nvar TraversalTracker = require('./traversalTracker');\r\nvar DocPreprocessor = require('./docPreprocessor');\r\nvar DocMeasure = require('./docMeasure');\r\nvar DocumentContext = require('./documentContext');\r\nvar PageElementWriter = require('./pageElementWriter');\r\nvar ColumnCalculator = require('./columnCalculator');\r\nvar TableProcessor = require('./tableProcessor');\r\nvar Line = require('./line');\r\nvar isString = require('./helpers').isString;\r\nvar isArray = require('./helpers').isArray;\r\nvar isUndefined = require('./helpers').isUndefined;\r\nvar isNull = require('./helpers').isNull;\r\nvar pack = require('./helpers').pack;\r\nvar offsetVector = require('./helpers').offsetVector;\r\nvar fontStringify = require('./helpers').fontStringify;\r\nvar getNodeId = require('./helpers').getNodeId;\r\nvar isFunction = require('./helpers').isFunction;\r\nvar TextTools = require('./textTools');\r\nvar StyleContextStack = require('./styleContextStack');\r\nvar isNumber = require('./helpers').isNumber;\r\n\r\nfunction addAll(target, otherArray) {\r\n\totherArray.forEach(function (item) {\r\n\t\ttarget.push(item);\r\n\t});\r\n}\r\n\r\n/**\r\n * Creates an instance of LayoutBuilder - layout engine which turns document-definition-object\r\n * into a set of pages, lines, inlines and vectors ready to be rendered into a PDF\r\n *\r\n * @param {Object} pageSize - an object defining page width and height\r\n * @param {Object} pageMargins - an object defining top, left, right and bottom margins\r\n */\r\nfunction LayoutBuilder(pageSize, pageMargins, imageMeasure, svgMeasure) {\r\n\tthis.pageSize = pageSize;\r\n\tthis.pageMargins = pageMargins;\r\n\tthis.tracker = new TraversalTracker();\r\n\tthis.imageMeasure = imageMeasure;\r\n\tthis.svgMeasure = svgMeasure;\r\n\tthis.tableLayouts = {};\r\n}\r\n\r\nLayoutBuilder.prototype.registerTableLayouts = function (tableLayouts) {\r\n\tthis.tableLayouts = pack(this.tableLayouts, tableLayouts);\r\n};\r\n\r\n/**\r\n * Executes layout engine on document-definition-object and creates an array of pages\r\n * containing positioned Blocks, Lines and inlines\r\n *\r\n * @param {Object} docStructure document-definition-object\r\n * @param {Object} fontProvider font provider\r\n * @param {Object} styleDictionary dictionary with style definitions\r\n * @param {Object} defaultStyle default style definition\r\n * @return {Array} an array of pages\r\n */\r\nLayoutBuilder.prototype.layoutDocument = function (docStructure, fontProvider, styleDictionary, defaultStyle, background, header, footer, images, watermark, pageBreakBeforeFct) {\r\n\r\n\tfunction addPageBreaksIfNecessary(linearNodeList, pages) {\r\n\r\n\t\tif (!isFunction(pageBreakBeforeFct)) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\tlinearNodeList = linearNodeList.filter(function (node) {\r\n\t\t\treturn node.positions.length > 0;\r\n\t\t});\r\n\r\n\t\tlinearNodeList.forEach(function (node) {\r\n\t\t\tvar nodeInfo = {};\r\n\t\t\t[\r\n\t\t\t\t'id', 'text', 'ul', 'ol', 'table', 'image', 'qr', 'canvas', 'svg', 'columns',\r\n\t\t\t\t'headlineLevel', 'style', 'pageBreak', 'pageOrientation',\r\n\t\t\t\t'width', 'height'\r\n\t\t\t].forEach(function (key) {\r\n\t\t\t\tif (node[key] !== undefined) {\r\n\t\t\t\t\tnodeInfo[key] = node[key];\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tnodeInfo.startPosition = node.positions[0];\r\n\t\t\tnodeInfo.pageNumbers = Array.from(new Set(node.positions.map(function (node) { return node.pageNumber; })));\r\n\t\t\tnodeInfo.pages = pages.length;\r\n\t\t\tnodeInfo.stack = isArray(node.stack);\r\n\r\n\t\t\tnode.nodeInfo = nodeInfo;\r\n\t\t});\r\n\r\n\t\tfor (var index = 0; index < linearNodeList.length; index++) {\r\n\t\t\tvar node = linearNodeList[index];\r\n\t\t\tif (node.pageBreak !== 'before' && !node.pageBreakCalculated) {\r\n\t\t\t\tnode.pageBreakCalculated = true;\r\n\t\t\t\tvar pageNumber = node.nodeInfo.pageNumbers[0];\r\n\t\t\t\tvar followingNodesOnPage = [];\r\n\t\t\t\tvar nodesOnNextPage = [];\r\n\t\t\t\tvar previousNodesOnPage = [];\r\n\t\t\t\tif (pageBreakBeforeFct.length > 1) {\r\n\t\t\t\t\tfor (var ii = index + 1, l = linearNodeList.length; ii < l; ii++) {\r\n\t\t\t\t\t\tif (linearNodeList[ii].nodeInfo.pageNumbers.indexOf(pageNumber) > -1) {\r\n\t\t\t\t\t\t\tfollowingNodesOnPage.push(linearNodeList[ii].nodeInfo);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (pageBreakBeforeFct.length > 2 && linearNodeList[ii].nodeInfo.pageNumbers.indexOf(pageNumber + 1) > -1) {\r\n\t\t\t\t\t\t\tnodesOnNextPage.push(linearNodeList[ii].nodeInfo);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (pageBreakBeforeFct.length > 3) {\r\n\t\t\t\t\tfor (var ii = 0; ii < index; ii++) {\r\n\t\t\t\t\t\tif (linearNodeList[ii].nodeInfo.pageNumbers.indexOf(pageNumber) > -1) {\r\n\t\t\t\t\t\t\tpreviousNodesOnPage.push(linearNodeList[ii].nodeInfo);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (pageBreakBeforeFct(node.nodeInfo, followingNodesOnPage, nodesOnNextPage, previousNodesOnPage)) {\r\n\t\t\t\t\tnode.pageBreak = 'before';\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn false;\r\n\t}\r\n\r\n\tthis.docPreprocessor = new DocPreprocessor();\r\n\tthis.docMeasure = new DocMeasure(fontProvider, styleDictionary, defaultStyle, this.imageMeasure, this.svgMeasure, this.tableLayouts, images);\r\n\r\n\r\n\tfunction resetXYs(result) {\r\n\t\tresult.linearNodeList.forEach(function (node) {\r\n\t\t\tnode.resetXY();\r\n\t\t});\r\n\t}\r\n\r\n\tvar result = this.tryLayoutDocument(docStructure, fontProvider, styleDictionary, defaultStyle, background, header, footer, images, watermark);\r\n\twhile (addPageBreaksIfNecessary(result.linearNodeList, result.pages)) {\r\n\t\tresetXYs(result);\r\n\t\tresult = this.tryLayoutDocument(docStructure, fontProvider, styleDictionary, defaultStyle, background, header, footer, images, watermark);\r\n\t}\r\n\r\n\treturn result.pages;\r\n};\r\n\r\nLayoutBuilder.prototype.tryLayoutDocument = function (docStructure, fontProvider, styleDictionary, defaultStyle, background, header, footer, images, watermark, pageBreakBeforeFct) {\r\n\r\n\tthis.linearNodeList = [];\r\n\tdocStructure = this.docPreprocessor.preprocessDocument(docStructure);\r\n\tdocStructure = this.docMeasure.measureDocument(docStructure);\r\n\r\n\tthis.writer = new PageElementWriter(\r\n\t\tnew DocumentContext(this.pageSize, this.pageMargins), this.tracker);\r\n\r\n\tvar _this = this;\r\n\tthis.writer.context().tracker.startTracking('pageAdded', function () {\r\n\t\t_this.addBackground(background);\r\n\t});\r\n\r\n\tthis.addBackground(background);\r\n\tthis.processNode(docStructure);\r\n\tthis.addHeadersAndFooters(header, footer);\r\n\tif (watermark != null) {\r\n\t\tthis.addWatermark(watermark, fontProvider, defaultStyle);\r\n\t}\r\n\r\n\treturn { pages: this.writer.context().pages, linearNodeList: this.linearNodeList };\r\n};\r\n\r\n\r\nLayoutBuilder.prototype.addBackground = function (background) {\r\n\tvar backgroundGetter = isFunction(background) ? background : function () {\r\n\t\treturn background;\r\n\t};\r\n\r\n\tvar context = this.writer.context();\r\n\tvar pageSize = context.getCurrentPage().pageSize;\r\n\r\n\tvar pageBackground = backgroundGetter(context.page + 1, pageSize);\r\n\r\n\tif (pageBackground) {\r\n\t\tthis.writer.beginUnbreakableBlock(pageSize.width, pageSize.height);\r\n\t\tpageBackground = this.docPreprocessor.preprocessDocument(pageBackground);\r\n\t\tthis.processNode(this.docMeasure.measureDocument(pageBackground));\r\n\t\tthis.writer.commitUnbreakableBlock(0, 0);\r\n\t\tcontext.backgroundLength[context.page] += pageBackground.positions.length;\r\n\t}\r\n};\r\n\r\nLayoutBuilder.prototype.addStaticRepeatable = function (headerOrFooter, sizeFunction) {\r\n\tthis.addDynamicRepeatable(function () {\r\n\t\treturn JSON.parse(JSON.stringify(headerOrFooter)); // copy to new object\r\n\t}, sizeFunction);\r\n};\r\n\r\nLayoutBuilder.prototype.addDynamicRepeatable = function (nodeGetter, sizeFunction) {\r\n\tvar pages = this.writer.context().pages;\r\n\r\n\tfor (var pageIndex = 0, l = pages.length; pageIndex < l; pageIndex++) {\r\n\t\tthis.writer.context().page = pageIndex;\r\n\r\n\t\tvar node = nodeGetter(pageIndex + 1, l, this.writer.context().pages[pageIndex].pageSize);\r\n\r\n\t\tif (node) {\r\n\t\t\tvar sizes = sizeFunction(this.writer.context().getCurrentPage().pageSize, this.pageMargins);\r\n\t\t\tthis.writer.beginUnbreakableBlock(sizes.width, sizes.height);\r\n\t\t\tnode = this.docPreprocessor.preprocessDocument(node);\r\n\t\t\tthis.processNode(this.docMeasure.measureDocument(node));\r\n\t\t\tthis.writer.commitUnbreakableBlock(sizes.x, sizes.y);\r\n\t\t}\r\n\t}\r\n};\r\n\r\nLayoutBuilder.prototype.addHeadersAndFooters = function (header, footer) {\r\n\tvar headerSizeFct = function (pageSize, pageMargins) {\r\n\t\treturn {\r\n\t\t\tx: 0,\r\n\t\t\ty: 0,\r\n\t\t\twidth: pageSize.width,\r\n\t\t\theight: pageMargins.top\r\n\t\t};\r\n\t};\r\n\r\n\tvar footerSizeFct = function (pageSize, pageMargins) {\r\n\t\treturn {\r\n\t\t\tx: 0,\r\n\t\t\ty: pageSize.height - pageMargins.bottom,\r\n\t\t\twidth: pageSize.width,\r\n\t\t\theight: pageMargins.bottom\r\n\t\t};\r\n\t};\r\n\r\n\tif (isFunction(header)) {\r\n\t\tthis.addDynamicRepeatable(header, headerSizeFct);\r\n\t} else if (header) {\r\n\t\tthis.addStaticRepeatable(header, headerSizeFct);\r\n\t}\r\n\r\n\tif (isFunction(footer)) {\r\n\t\tthis.addDynamicRepeatable(footer, footerSizeFct);\r\n\t} else if (footer) {\r\n\t\tthis.addStaticRepeatable(footer, footerSizeFct);\r\n\t}\r\n};\r\n\r\nLayoutBuilder.prototype.addWatermark = function (watermark, fontProvider, defaultStyle) {\r\n\tif (isString(watermark)) {\r\n\t\twatermark = { 'text': watermark };\r\n\t}\r\n\r\n\tif (!watermark.text) { // empty watermark text\r\n\t\treturn;\r\n\t}\r\n\r\n\twatermark.font = watermark.font || defaultStyle.font || 'Roboto';\r\n\twatermark.fontSize = watermark.fontSize || 'auto';\r\n\twatermark.color = watermark.color || 'black';\r\n\twatermark.opacity = isNumber(watermark.opacity) ? watermark.opacity : 0.6;\r\n\twatermark.bold = watermark.bold || false;\r\n\twatermark.italics = watermark.italics || false;\r\n\twatermark.angle = !isUndefined(watermark.angle) && !isNull(watermark.angle) ? watermark.angle : null;\r\n\r\n\tif (watermark.angle === null) {\r\n\t\twatermark.angle = Math.atan2(this.pageSize.height, this.pageSize.width) * -180 / Math.PI;\r\n\t}\r\n\r\n\tif (watermark.fontSize === 'auto') {\r\n\t\twatermark.fontSize = getWatermarkFontSize(this.pageSize, watermark, fontProvider);\r\n\t}\r\n\r\n\tvar watermarkObject = {\r\n\t\ttext: watermark.text,\r\n\t\tfont: fontProvider.provideFont(watermark.font, watermark.bold, watermark.italics),\r\n\t\tfontSize: watermark.fontSize,\r\n\t\tcolor: watermark.color,\r\n\t\topacity: watermark.opacity,\r\n\t\tangle: watermark.angle\r\n\t};\r\n\r\n\twatermarkObject._size = getWatermarkSize(watermark, fontProvider);\r\n\r\n\tvar pages = this.writer.context().pages;\r\n\tfor (var i = 0, l = pages.length; i < l; i++) {\r\n\t\tpages[i].watermark = watermarkObject;\r\n\t}\r\n\r\n\tfunction getWatermarkSize(watermark, fontProvider) {\r\n\t\tvar textTools = new TextTools(fontProvider);\r\n\t\tvar styleContextStack = new StyleContextStack(null, { font: watermark.font, bold: watermark.bold, italics: watermark.italics });\r\n\r\n\t\tstyleContextStack.push({\r\n\t\t\tfontSize: watermark.fontSize\r\n\t\t});\r\n\r\n\t\tvar size = textTools.sizeOfString(watermark.text, styleContextStack);\r\n\t\tvar rotatedSize = textTools.sizeOfRotatedText(watermark.text, watermark.angle, styleContextStack);\r\n\r\n\t\treturn { size: size, rotatedSize: rotatedSize };\r\n\t}\r\n\r\n\tfunction getWatermarkFontSize(pageSize, watermark, fontProvider) {\r\n\t\tvar textTools = new TextTools(fontProvider);\r\n\t\tvar styleContextStack = new StyleContextStack(null, { font: watermark.font, bold: watermark.bold, italics: watermark.italics });\r\n\t\tvar rotatedSize;\r\n\r\n\t\t/**\r\n\t\t * Binary search the best font size.\r\n\t\t * Initial bounds [0, 1000]\r\n\t\t * Break when range < 1\r\n\t\t */\r\n\t\tvar a = 0;\r\n\t\tvar b = 1000;\r\n\t\tvar c = (a + b) / 2;\r\n\t\twhile (Math.abs(a - b) > 1) {\r\n\t\t\tstyleContextStack.push({\r\n\t\t\t\tfontSize: c\r\n\t\t\t});\r\n\t\t\trotatedSize = textTools.sizeOfRotatedText(watermark.text, watermark.angle, styleContextStack);\r\n\t\t\tif (rotatedSize.width > pageSize.width) {\r\n\t\t\t\tb = c;\r\n\t\t\t\tc = (a + b) / 2;\r\n\t\t\t} else if (rotatedSize.width < pageSize.width) {\r\n\t\t\t\tif (rotatedSize.height > pageSize.height) {\r\n\t\t\t\t\tb = c;\r\n\t\t\t\t\tc = (a + b) / 2;\r\n\t\t\t\t} else {\r\n\t\t\t\t\ta = c;\r\n\t\t\t\t\tc = (a + b) / 2;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tstyleContextStack.pop();\r\n\t\t}\r\n\t\t/*\r\n\t\t End binary search\r\n\t\t */\r\n\t\treturn c;\r\n\t}\r\n};\r\n\r\nfunction decorateNode(node) {\r\n\tvar x = node.x, y = node.y;\r\n\tnode.positions = [];\r\n\r\n\tif (isArray(node.canvas)) {\r\n\t\tnode.canvas.forEach(function (vector) {\r\n\t\t\tvar x = vector.x, y = vector.y, x1 = vector.x1, y1 = vector.y1, x2 = vector.x2, y2 = vector.y2;\r\n\t\t\tvector.resetXY = function () {\r\n\t\t\t\tvector.x = x;\r\n\t\t\t\tvector.y = y;\r\n\t\t\t\tvector.x1 = x1;\r\n\t\t\t\tvector.y1 = y1;\r\n\t\t\t\tvector.x2 = x2;\r\n\t\t\t\tvector.y2 = y2;\r\n\t\t\t};\r\n\t\t});\r\n\t}\r\n\r\n\tnode.resetXY = function () {\r\n\t\tnode.x = x;\r\n\t\tnode.y = y;\r\n\t\tif (isArray(node.canvas)) {\r\n\t\t\tnode.canvas.forEach(function (vector) {\r\n\t\t\t\tvector.resetXY();\r\n\t\t\t});\r\n\t\t}\r\n\t};\r\n}\r\n\r\nLayoutBuilder.prototype.processNode = function (node) {\r\n\tvar self = this;\r\n\r\n\tthis.linearNodeList.push(node);\r\n\tdecorateNode(node);\r\n\r\n\tapplyMargins(function () {\r\n\t\tvar unbreakable = node.unbreakable;\r\n\t\tif (unbreakable) {\r\n\t\t\tself.writer.beginUnbreakableBlock();\r\n\t\t}\r\n\r\n\t\tvar absPosition = node.absolutePosition;\r\n\t\tif (absPosition) {\r\n\t\t\tself.writer.context().beginDetachedBlock();\r\n\t\t\tself.writer.context().moveTo(absPosition.x || 0, absPosition.y || 0);\r\n\t\t}\r\n\r\n\t\tvar relPosition = node.relativePosition;\r\n\t\tif (relPosition) {\r\n\t\t\tself.writer.context().beginDetachedBlock();\r\n\t\t\tself.writer.context().moveToRelative(relPosition.x || 0, relPosition.y || 0);\r\n\t\t}\r\n\r\n\t\tif (node.stack) {\r\n\t\t\tself.processVerticalContainer(node);\r\n\t\t} else if (node.columns) {\r\n\t\t\tself.processColumns(node);\r\n\t\t} else if (node.ul) {\r\n\t\t\tself.processList(false, node);\r\n\t\t} else if (node.ol) {\r\n\t\t\tself.processList(true, node);\r\n\t\t} else if (node.table) {\r\n\t\t\tself.processTable(node);\r\n\t\t} else if (node.text !== undefined) {\r\n\t\t\tself.processLeaf(node);\r\n\t\t} else if (node.toc) {\r\n\t\t\tself.processToc(node);\r\n\t\t} else if (node.image) {\r\n\t\t\tself.processImage(node);\r\n\t\t} else if (node.svg) {\r\n\t\t\tself.processSVG(node);\r\n\t\t} else if (node.canvas) {\r\n\t\t\tself.processCanvas(node);\r\n\t\t} else if (node.qr) {\r\n\t\t\tself.processQr(node);\r\n\t\t} else if (!node._span) {\r\n\t\t\tthrow 'Unrecognized document structure: ' + JSON.stringify(node, fontStringify);\r\n\t\t}\r\n\r\n\t\tif (absPosition || relPosition) {\r\n\t\t\tself.writer.context().endDetachedBlock();\r\n\t\t}\r\n\r\n\t\tif (unbreakable) {\r\n\t\t\tself.writer.commitUnbreakableBlock();\r\n\t\t}\r\n\t});\r\n\r\n\tfunction applyMargins(callback) {\r\n\t\tvar margin = node._margin;\r\n\r\n\t\tif (node.pageBreak === 'before') {\r\n\t\t\tself.writer.moveToNextPage(node.pageOrientation);\r\n\t\t} else if (node.pageBreak === 'beforeOdd') {\r\n\t\t\tself.writer.moveToNextPage(node.pageOrientation);\r\n\t\t\tif ((self.writer.context().page + 1) % 2 === 1) {\r\n\t\t\t\tself.writer.moveToNextPage(node.pageOrientation);\r\n\t\t\t}\r\n\t\t} else if (node.pageBreak === 'beforeEven') {\r\n\t\t\tself.writer.moveToNextPage(node.pageOrientation);\r\n\t\t\tif ((self.writer.context().page + 1) % 2 === 0) {\r\n\t\t\t\tself.writer.moveToNextPage(node.pageOrientation);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (margin) {\r\n\t\t\tself.writer.context().moveDown(margin[1]);\r\n\t\t\tself.writer.context().addMargin(margin[0], margin[2]);\r\n\t\t}\r\n\r\n\t\tcallback();\r\n\r\n\t\tif (margin) {\r\n\t\t\tself.writer.context().addMargin(-margin[0], -margin[2]);\r\n\t\t\tself.writer.context().moveDown(margin[3]);\r\n\t\t}\r\n\r\n\t\tif (node.pageBreak === 'after') {\r\n\t\t\tself.writer.moveToNextPage(node.pageOrientation);\r\n\t\t} else if (node.pageBreak === 'afterOdd') {\r\n\t\t\tself.writer.moveToNextPage(node.pageOrientation);\r\n\t\t\tif ((self.writer.context().page + 1) % 2 === 1) {\r\n\t\t\t\tself.writer.moveToNextPage(node.pageOrientation);\r\n\t\t\t}\r\n\t\t} else if (node.pageBreak === 'afterEven') {\r\n\t\t\tself.writer.moveToNextPage(node.pageOrientation);\r\n\t\t\tif ((self.writer.context().page + 1) % 2 === 0) {\r\n\t\t\t\tself.writer.moveToNextPage(node.pageOrientation);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n};\r\n\r\n// vertical container\r\nLayoutBuilder.prototype.processVerticalContainer = function (node) {\r\n\tvar self = this;\r\n\tnode.stack.forEach(function (item) {\r\n\t\tself.processNode(item);\r\n\t\taddAll(node.positions, item.positions);\r\n\r\n\t\t//TODO: paragraph gap\r\n\t});\r\n};\r\n\r\n// columns\r\nLayoutBuilder.prototype.processColumns = function (columnNode) {\r\n\tvar columns = columnNode.columns;\r\n\tvar availableWidth = this.writer.context().availableWidth;\r\n\tvar gaps = gapArray(columnNode._gap);\r\n\r\n\tif (gaps) {\r\n\t\tavailableWidth -= (gaps.length - 1) * columnNode._gap;\r\n\t}\r\n\r\n\tColumnCalculator.buildColumnWidths(columns, availableWidth);\r\n\tvar result = this.processRow(columns, columns, gaps);\r\n\taddAll(columnNode.positions, result.positions);\r\n\r\n\r\n\tfunction gapArray(gap) {\r\n\t\tif (!gap) {\r\n\t\t\treturn null;\r\n\t\t}\r\n\r\n\t\tvar gaps = [];\r\n\t\tgaps.push(0);\r\n\r\n\t\tfor (var i = columns.length - 1; i > 0; i--) {\r\n\t\t\tgaps.push(gap);\r\n\t\t}\r\n\r\n\t\treturn gaps;\r\n\t}\r\n};\r\n\r\nLayoutBuilder.prototype.processRow = function (columns, widths, gaps, tableBody, tableRow, height) {\r\n\tvar self = this;\r\n\tvar pageBreaks = [], positions = [];\r\n\r\n\tthis.tracker.auto('pageChanged', storePageBreakData, function () {\r\n\t\twidths = widths || columns;\r\n\r\n\t\tself.writer.context().beginColumnGroup();\r\n\r\n\t\tfor (var i = 0, l = columns.length; i < l; i++) {\r\n\t\t\tvar column = columns[i];\r\n\t\t\tvar width = widths[i]._calcWidth;\r\n\t\t\tvar leftOffset = colLeftOffset(i);\r\n\r\n\t\t\tif (column.colSpan && column.colSpan > 1) {\r\n\t\t\t\tfor (var j = 1; j < column.colSpan; j++) {\r\n\t\t\t\t\twidth += widths[++i]._calcWidth + gaps[i];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tself.writer.context().beginColumn(width, leftOffset, getEndingCell(column, i));\r\n\t\t\tif (!column._span) {\r\n\t\t\t\tself.processNode(column);\r\n\t\t\t\taddAll(positions, column.positions);\r\n\t\t\t} else if (column._columnEndingContext) {\r\n\t\t\t\t// row-span ending\r\n\t\t\t\tself.writer.context().markEnding(column);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tself.writer.context().completeColumnGroup(height);\r\n\t});\r\n\r\n\treturn { pageBreaks: pageBreaks, positions: positions };\r\n\r\n\tfunction storePageBreakData(data) {\r\n\t\tvar pageDesc;\r\n\r\n\t\tfor (var i = 0, l = pageBreaks.length; i < l; i++) {\r\n\t\t\tvar desc = pageBreaks[i];\r\n\t\t\tif (desc.prevPage === data.prevPage) {\r\n\t\t\t\tpageDesc = desc;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (!pageDesc) {\r\n\t\t\tpageDesc = data;\r\n\t\t\tpageBreaks.push(pageDesc);\r\n\t\t}\r\n\t\tpageDesc.prevY = Math.max(pageDesc.prevY, data.prevY);\r\n\t\tpageDesc.y = Math.min(pageDesc.y, data.y);\r\n\t}\r\n\r\n\tfunction colLeftOffset(i) {\r\n\t\tif (gaps && gaps.length > i) {\r\n\t\t\treturn gaps[i];\r\n\t\t}\r\n\t\treturn 0;\r\n\t}\r\n\r\n\tfunction getEndingCell(column, columnIndex) {\r\n\t\tif (column.rowSpan && column.rowSpan > 1) {\r\n\t\t\tvar endingRow = tableRow + column.rowSpan - 1;\r\n\t\t\tif (endingRow >= tableBody.length) {\r\n\t\t\t\tthrow 'Row span for column ' + columnIndex + ' (with indexes starting from 0) exceeded row count';\r\n\t\t\t}\r\n\t\t\treturn tableBody[endingRow][columnIndex];\r\n\t\t}\r\n\r\n\t\treturn null;\r\n\t}\r\n};\r\n\r\n// lists\r\nLayoutBuilder.prototype.processList = function (orderedList, node) {\r\n\tvar self = this,\r\n\t\titems = orderedList ? node.ol : node.ul,\r\n\t\tgapSize = node._gapSize;\r\n\r\n\tthis.writer.context().addMargin(gapSize.width);\r\n\r\n\tvar nextMarker;\r\n\tthis.tracker.auto('lineAdded', addMarkerToFirstLeaf, function () {\r\n\t\titems.forEach(function (item) {\r\n\t\t\tnextMarker = item.listMarker;\r\n\t\t\tself.processNode(item);\r\n\t\t\taddAll(node.positions, item.positions);\r\n\t\t});\r\n\t});\r\n\r\n\tthis.writer.context().addMargin(-gapSize.width);\r\n\r\n\tfunction addMarkerToFirstLeaf(line) {\r\n\t\t// I'm not very happy with the way list processing is implemented\r\n\t\t// (both code and algorithm should be rethinked)\r\n\t\tif (nextMarker) {\r\n\t\t\tvar marker = nextMarker;\r\n\t\t\tnextMarker = null;\r\n\r\n\t\t\tif (marker.canvas) {\r\n\t\t\t\tvar vector = marker.canvas[0];\r\n\r\n\t\t\t\toffsetVector(vector, -marker._minWidth, 0);\r\n\t\t\t\tself.writer.addVector(vector);\r\n\t\t\t} else if (marker._inlines) {\r\n\t\t\t\tvar markerLine = new Line(self.pageSize.width);\r\n\t\t\t\tmarkerLine.addInline(marker._inlines[0]);\r\n\t\t\t\tmarkerLine.x = -marker._minWidth;\r\n\t\t\t\tmarkerLine.y = line.getAscenderHeight() - markerLine.getAscenderHeight();\r\n\t\t\t\tself.writer.addLine(markerLine, true);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n};\r\n\r\n// tables\r\nLayoutBuilder.prototype.processTable = function (tableNode) {\r\n\tvar processor = new TableProcessor(tableNode);\r\n\r\n\tprocessor.beginTable(this.writer);\r\n\r\n\tvar rowHeights = tableNode.table.heights;\r\n\tfor (var i = 0, l = tableNode.table.body.length; i < l; i++) {\r\n\t\tprocessor.beginRow(i, this.writer);\r\n\r\n\t\tvar height;\r\n\t\tif (isFunction(rowHeights)) {\r\n\t\t\theight = rowHeights(i);\r\n\t\t} else if (isArray(rowHeights)) {\r\n\t\t\theight = rowHeights[i];\r\n\t\t} else {\r\n\t\t\theight = rowHeights;\r\n\t\t}\r\n\r\n\t\tif (height === 'auto') {\r\n\t\t\theight = undefined;\r\n\t\t}\r\n\r\n\t\tvar result = this.processRow(tableNode.table.body[i], tableNode.table.widths, tableNode._offsets.offsets, tableNode.table.body, i, height);\r\n\t\taddAll(tableNode.positions, result.positions);\r\n\r\n\t\tprocessor.endRow(i, this.writer, result.pageBreaks);\r\n\t}\r\n\r\n\tprocessor.endTable(this.writer);\r\n};\r\n\r\n// leafs (texts)\r\nLayoutBuilder.prototype.processLeaf = function (node) {\r\n\tvar line = this.buildNextLine(node);\r\n\tif (line && (node.tocItem || node.id)) {\r\n\t\tline._node = node;\r\n\t}\r\n\tvar currentHeight = (line) ? line.getHeight() : 0;\r\n\tvar maxHeight = node.maxHeight || -1;\r\n\r\n\tif (line) {\r\n\t\tvar nodeId = getNodeId(node);\r\n\t\tif (nodeId) {\r\n\t\t\tline.id = nodeId;\r\n\t\t}\r\n\t}\r\n\r\n\tif (node._tocItemRef) {\r\n\t\tline._pageNodeRef = node._tocItemRef;\r\n\t}\r\n\r\n\tif (node._pageRef) {\r\n\t\tline._pageNodeRef = node._pageRef._nodeRef;\r\n\t}\r\n\r\n\tif (line && line.inlines && isArray(line.inlines)) {\r\n\t\tfor (var i = 0, l = line.inlines.length; i < l; i++) {\r\n\t\t\tif (line.inlines[i]._tocItemRef) {\r\n\t\t\t\tline.inlines[i]._pageNodeRef = line.inlines[i]._tocItemRef;\r\n\t\t\t}\r\n\r\n\t\t\tif (line.inlines[i]._pageRef) {\r\n\t\t\t\tline.inlines[i]._pageNodeRef = line.inlines[i]._pageRef._nodeRef;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\twhile (line && (maxHeight === -1 || currentHeight < maxHeight)) {\r\n\t\tvar positions = this.writer.addLine(line);\r\n\t\tnode.positions.push(positions);\r\n\t\tline = this.buildNextLine(node);\r\n\t\tif (line) {\r\n\t\t\tcurrentHeight += line.getHeight();\r\n\t\t}\r\n\t}\r\n};\r\n\r\nLayoutBuilder.prototype.processToc = function (node) {\r\n\tif (node.toc.title) {\r\n\t\tthis.processNode(node.toc.title);\r\n\t}\r\n\tif (node.toc._table) {\r\n\t\tthis.processNode(node.toc._table);\r\n\t}\r\n};\r\n\r\nLayoutBuilder.prototype.buildNextLine = function (textNode) {\r\n\r\n\tfunction cloneInline(inline) {\r\n\t\tvar newInline = inline.constructor();\r\n\t\tfor (var key in inline) {\r\n\t\t\tnewInline[key] = inline[key];\r\n\t\t}\r\n\t\treturn newInline;\r\n\t}\r\n\r\n\tif (!textNode._inlines || textNode._inlines.length === 0) {\r\n\t\treturn null;\r\n\t}\r\n\r\n\tvar line = new Line(this.writer.context().availableWidth);\r\n\tvar textTools = new TextTools(null);\r\n\r\n\tvar isForceContinue = false;\r\n\twhile (textNode._inlines && textNode._inlines.length > 0 &&\r\n\t\t(line.hasEnoughSpaceForInline(textNode._inlines[0], textNode._inlines.slice(1)) || isForceContinue)) {\r\n\t\tvar isHardWrap = false;\r\n\t\tvar inline = textNode._inlines.shift();\r\n\t\tisForceContinue = false;\r\n\r\n\t\tif (!inline.noWrap && inline.text.length > 1 && inline.width > line.getAvailableWidth()) {\r\n\t\t\tvar widthPerChar = inline.width / inline.text.length;\r\n\t\t\tvar maxChars = Math.floor(line.getAvailableWidth() / widthPerChar);\r\n\t\t\tif (maxChars < 1) {\r\n\t\t\t\tmaxChars = 1;\r\n\t\t\t}\r\n\t\t\tif (maxChars < inline.text.length) {\r\n\t\t\t\tvar newInline = cloneInline(inline);\r\n\r\n\t\t\t\tnewInline.text = inline.text.substr(maxChars);\r\n\t\t\t\tinline.text = inline.text.substr(0, maxChars);\r\n\r\n\t\t\t\tnewInline.width = textTools.widthOfString(newInline.text, newInline.font, newInline.fontSize, newInline.characterSpacing, newInline.fontFeatures);\r\n\t\t\t\tinline.width = textTools.widthOfString(inline.text, inline.font, inline.fontSize, inline.characterSpacing, inline.fontFeatures);\r\n\r\n\t\t\t\ttextNode._inlines.unshift(newInline);\r\n\t\t\t\tisHardWrap = true;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tline.addInline(inline);\r\n\r\n\t\tisForceContinue = inline.noNewLine && !isHardWrap;\r\n\t}\r\n\r\n\tline.lastLineInParagraph = textNode._inlines.length === 0;\r\n\r\n\treturn line;\r\n};\r\n\r\n// images\r\nLayoutBuilder.prototype.processImage = function (node) {\r\n\tvar position = this.writer.addImage(node);\r\n\tnode.positions.push(position);\r\n};\r\n\r\nLayoutBuilder.prototype.processSVG = function (node) {\r\n\tvar position = this.writer.addSVG(node);\r\n\tnode.positions.push(position);\r\n};\r\n\r\nLayoutBuilder.prototype.processCanvas = function (node) {\r\n\tvar height = node._minHeight;\r\n\r\n\tif (node.absolutePosition === undefined && this.writer.context().availableHeight < height) {\r\n\t\t// TODO: support for canvas larger than a page\r\n\t\t// TODO: support for other overflow methods\r\n\r\n\t\tthis.writer.moveToNextPage();\r\n\t}\r\n\r\n\tthis.writer.alignCanvas(node);\r\n\r\n\tnode.canvas.forEach(function (vector) {\r\n\t\tvar position = this.writer.addVector(vector);\r\n\t\tnode.positions.push(position);\r\n\t}, this);\r\n\r\n\tthis.writer.context().moveDown(height);\r\n};\r\n\r\nLayoutBuilder.prototype.processQr = function (node) {\r\n\tvar position = this.writer.addQr(node);\r\n\tnode.positions.push(position);\r\n};\r\n\r\nmodule.exports = LayoutBuilder;\r\n"]},"metadata":{},"sourceType":"script"}